<div class="page">
  <div class="header">
    <div>
      <h1>Solicitudes</h1>
      <p class="muted">Gestiona las solicitudes de soporte técnico</p>
    </div>

    <button mat-flat-button class="btn-primary" (click)="nueva()">
      <mat-icon>add</mat-icon>
      Nueva Solicitud
    </button>
  </div>

  <mat-card class="card elevation-1">
    <mat-card-header class="filters-header">
      <mat-card-title class="filters-title">
        <mat-icon class="icon-primary">filter_alt</mat-icon>
        Filtros
      </mat-card-title>
      <mat-card-subtitle>Filtra y busca solicitudes</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content class="filters-wrap">
      <form class="filters-grid" [formGroup]="form">
        <mat-form-field appearance="outline">
          <mat-label>Buscar por título</mat-label>
          <mat-icon matPrefix>search</mat-icon>
          <input matInput placeholder="Buscar..." formControlName="titulo" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select formControlName="estado">
            <mat-option value="TODOS">Todos</mat-option>
            <mat-option *ngFor="let e of estados" [value]="e">
              {{ estadoLabel(e) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Prioridad</mat-label>
          <mat-select formControlName="prioridad">
            <mat-option value="TODAS">Todas</mat-option>
            <mat-option *ngFor="let p of prioridades" [value]="p">
              {{ prioridadLabel(p) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Desde</mat-label>
          <input matInput type="date" formControlName="desde" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Hasta</mat-label>
          <input matInput type="date" formControlName="hasta" />
        </mat-form-field>

        <div class="filters-actions">
          <button mat-stroked-button type="button" (click)="limpiar()">
            <mat-icon>close</mat-icon>
            Limpiar filtros
          </button>

          <span class="results">{{ totalFiltrados() }} resultado(s)</span>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <mat-card class="card elevation-1">
    <mat-card-header class="table-header">
      <mat-card-title class="filters-title">
        <mat-icon class="icon-primary">description</mat-icon>
        Lista de Solicitudes
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="loading" *ngIf="isLoading">
        <mat-spinner diameter="36"></mat-spinner>
      </div>

      <div class="empty" *ngIf="!isLoading && paginados().length === 0">
        <mat-icon class="empty-icon">description</mat-icon>
        <h3>No se encontraron solicitudes</h3>
        <p class="muted">Intenta ajustar los filtros o crea una nueva solicitud</p>
        <button mat-flat-button class="btn-primary" (click)="nueva()">
          <mat-icon>add</mat-icon>
          Nueva Solicitud
        </button>
      </div>

      <div class="table-wrap" *ngIf="!isLoading && paginados().length > 0">
        <table mat-table [dataSource]="paginados()" class="mat-elevation-z0">

          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef class="w-id">ID</th>
            <td mat-cell *matCellDef="let s" class="mono">
              {{ 'SOL-' + (s.id | number:'3.0-0') }}
            </td>
          </ng-container>

          <ng-container matColumnDef="titulo">
            <th mat-header-cell *matHeaderCellDef>Título</th>
            <td mat-cell *matCellDef="let s" class="td-title">{{ s.titulo }}</td>
          </ng-container>

          <ng-container matColumnDef="solicitante">
            <th mat-header-cell *matHeaderCellDef>Solicitante</th>
            <td mat-cell *matCellDef="let s">{{ s.solicitanteUser?.nombres }}</td>
          </ng-container>

          <ng-container matColumnDef="prioridad">
            <th mat-header-cell *matHeaderCellDef>Prioridad</th>
            <td mat-cell *matCellDef="let s">
              <span class="chip chip-prioridad" [attr.data-p]="s.prioridad">
                {{ prioridadLabel(s.prioridad) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let s">
              <span class="chip chip-estado" [attr.data-e]="s.estado">
                {{ estadoLabel(s.estado) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="fechaCreacion">
            <th mat-header-cell *matHeaderCellDef>Fecha Creación</th>
            <td mat-cell *matCellDef="let s" class="muted-sm">
              {{ s.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="fechaActualizacion">
            <th mat-header-cell *matHeaderCellDef>Última Act.</th>
            <td mat-cell *matCellDef="let s" class="muted-sm">
              {{ s.fechaActualizacion | date:'dd/MM/yyyy HH:mm' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef class="text-right">Acciones</th>
            <td mat-cell *matCellDef="let s" class="text-right">
              <button mat-icon-button matTooltip="Ver detalle" (click)="ver(s.id)">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Editar" (click)="editar(s.id)">
                <mat-icon>edit</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns" class="row"></tr>
        </table>
      </div>

      <div class="pager" *ngIf="!isLoading && totalPages() > 1">
        <p class="muted-sm">Página {{ currentPage() }} de {{ totalPages() }}</p>

        <div class="pager-actions">
          <button mat-stroked-button (click)="prev()" [disabled]="currentPage() === 1">
            Anterior
          </button>
          <button mat-stroked-button (click)="next()" [disabled]="currentPage() === totalPages()">
            Siguiente
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
